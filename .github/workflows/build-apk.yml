name: ğŸ“± Build Android APK

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  ÙŠÙØ´ØºÙÙ‘Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† GitHub Actions Ø£Ùˆ Ø¹Ù†Ø¯ Ø±ÙØ¹ ÙƒÙˆØ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

permissions:
  contents: write

jobs:
  build:
    name: ğŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:

      # â”€â”€ 1. Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯ â”€â”€
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ 2. Ø¥Ø¹Ø¯Ø§Ø¯ Java 17 â”€â”€
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      # â”€â”€ 3. Ø¥Ø¹Ø¯Ø§Ø¯ Node.js 20 â”€â”€
      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      # â”€â”€ 4. ØªØ«Ø¨ÙŠØª ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ â”€â”€
      - name: ğŸ“¦ Install npm dependencies
        run: npm ci --prefer-offline || npm install

      # â”€â”€ 5. Ø¨Ù†Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Vite (ÙŠÙ†ØªØ¬ Ù…Ø¬Ù„Ø¯ dist/) â”€â”€
      - name: ğŸ”¨ Build Vite project
        run: npm run build
        env:
          NODE_ENV: production

      # â”€â”€ 6. ØªØ«Ø¨ÙŠØª Capacitor â”€â”€
      - name: âš¡ Install Capacitor packages
        run: |
          npm install --save-exact \
            @capacitor/core@latest \
            @capacitor/cli@latest \
            @capacitor/android@latest

      # â”€â”€ 7. Ø¥Ù†Ø´Ø§Ø¡ capacitor.config.json Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ â”€â”€
      - name: ğŸ“ Ensure capacitor.config.json
        run: |
          cat > capacitor.config.json << 'EOF'
          {
            "appId": "com.ouldbouzidi.invoicemanager",
            "appName": "Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ±",
            "webDir": "dist",
            "android": {
              "allowMixedContent": true,
              "captureInput": true,
              "webContentsDebuggingEnabled": false
            }
          }
          EOF

      # â”€â”€ 8. Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ© Android (Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©) â”€â”€
      - name: ğŸ“± Add Android platform
        run: |
          if [ ! -f "android/app/build.gradle" ]; then
            echo "Adding Android platform..."
            npx cap add android
          else
            echo "Android platform already exists"
          fi

      # â”€â”€ 9. Ù…Ø²Ø§Ù…Ù†Ø© Capacitor Ù…Ø¹ Android â”€â”€
      - name: ğŸ”„ Sync Capacitor with Android
        run: npx cap sync android

      # â”€â”€ 10. Ø¥Ù†Ø´Ø§Ø¡ local.properties Ù…Ø¹ Android SDK â”€â”€
      - name: ğŸ”§ Setup Android SDK path
        run: |
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          cat android/local.properties

      # â”€â”€ 11. Ø¥Ø¹Ø¯Ø§Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Gradle â”€â”€
      - name: ğŸ”‘ Grant execute permission to gradlew
        run: chmod +x android/gradlew

      # â”€â”€ 12. ØªÙ†Ø²ÙŠÙ„ ØªØ¨Ø¹ÙŠØ§Øª Gradle (Ù…Ø¹ cache) â”€â”€
      - name: ğŸ“¥ Download Gradle dependencies
        working-directory: android
        run: ./gradlew dependencies --no-daemon --quiet || true

      # â”€â”€ 13. Ø¨Ù†Ø§Ø¡ APK Debug â”€â”€
      - name: ğŸ—ï¸ Build DEBUG APK
        if: ${{ github.event.inputs.build_type != 'release' }}
        working-directory: android
        run: |
          ./gradlew assembleDebug \
            --no-daemon \
            --stacktrace \
            -Dorg.gradle.jvmargs="-Xmx3072m" \
            -Dorg.gradle.daemon=false

      # â”€â”€ 14. Ø¨Ù†Ø§Ø¡ APK Release (Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚ÙŠØ¹) â”€â”€
      - name: ğŸ—ï¸ Build RELEASE APK
        if: ${{ github.event.inputs.build_type == 'release' }}
        working-directory: android
        run: |
          ./gradlew assembleRelease \
            --no-daemon \
            --stacktrace \
            -Dorg.gradle.jvmargs="-Xmx3072m" \
            -Dorg.gradle.daemon=false

      # â”€â”€ 15. Ø¥ÙŠØ¬Ø§Ø¯ Ù…Ù„Ù APK ÙˆØªØ³Ù…ÙŠØªÙ‡ â”€â”€
      - name: ğŸ” Locate and rename APK
        id: apk_info
        run: |
          APK_PATH=$(find android -name "*.apk" -not -path "*/intermediates/*" | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "âŒ APK not found!"
            find android -name "*.apk" || true
            exit 1
          fi
          APK_NAME="invoice-manager-${{ github.event.inputs.build_type || 'debug' }}-v${{ github.run_number }}.apk"
          cp "$APK_PATH" "$APK_NAME"
          APK_SIZE=$(du -sh "$APK_NAME" | cut -f1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "âœ… APK ready: $APK_NAME ($APK_SIZE)"

      # â”€â”€ 16. Ø±ÙØ¹ APK ÙƒÙ€ Artifact (ØµØ§Ù„Ø­ 30 ÙŠÙˆÙ…) â”€â”€
      - name: ğŸ“¤ Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ“± invoice-manager-apk-v${{ github.run_number }}
          path: ${{ steps.apk_info.outputs.apk_name }}
          retention-days: 30
          if-no-files-found: error

      # â”€â”€ 17. Ø¥Ù†Ø´Ø§Ø¡ GitHub Release ØªÙ„Ù‚Ø§Ø¦ÙŠ â”€â”€
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}-apk
          name: "ğŸ“± Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± - APK Build #${{ github.run_number }}"
          body: |
            ## ğŸ“± Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†
            ### ØªØ·Ø¨ÙŠÙ‚ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª

            ---

            ### â¬‡ï¸ ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª:
            1. **Ø­Ù…Ù‘Ù„** Ù…Ù„Ù `.apk` Ù…Ù† Ù‚Ø³Ù… **Assets** Ø£Ø¯Ù†Ø§Ù‡
            2. **Ø§Ù†Ù‚Ù„** Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ù‡Ø§ØªÙÙƒ (Ø¹Ø¨Ø± USB Ø£Ùˆ ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ùˆ Bluetooth)
            3. **ÙØ¹Ù‘Ù„** "ØªØ«Ø¨ÙŠØª Ù…Ù† Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©":
               - Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ **Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„Ø£Ù…Ø§Ù†** (Ø£Ùˆ ØªØ·Ø¨ÙŠÙ‚Ø§Øª â†’ Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©)
               - ÙØ¹Ù‘Ù„ **"Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©"** Ø£Ùˆ **"Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª"**
            4. **Ø§ÙØªØ­** Ù…Ù„Ù APK ÙˆØ§Ø¶ØºØ· **ØªØ«Ø¨ÙŠØª** âœ…

            ---

            ### ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡:
            | | |
            |---|---|
            | ğŸ”¢ **Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡** | #${{ github.run_number }} |
            | ğŸ“¦ **Ø§Ù„Ø­Ø¬Ù…** | ${{ steps.apk_info.outputs.apk_size }} |
            | ğŸ”§ **Ø§Ù„Ù†ÙˆØ¹** | ${{ github.event.inputs.build_type || 'debug' }} |
            | ğŸ“… **Ø§Ù„ØªØ§Ø±ÙŠØ®** | ${{ github.run_started_at }} |
            | ğŸ¤– **Android** | API 23+ (6.0 ÙØ£Ø¹Ù„Ù‰) |

            ---

            ### âœ¨ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:
            - ğŸ§¾ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ
            - ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØ¨ÙŠØ§Ù†Ø§ØªÙ‡Ù…
            - ğŸ“¦ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª
            - ğŸ’° ØªØªØ¨Ø¹ Ø¯ÙŠÙˆÙ† Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª
            - ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨ØµÙŠØºØ© PDF
            - ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª)

            ---
            > âš ï¸ **Ù…Ù„Ø§Ø­Ø¸Ø©:** Ù‡Ø°Ø§ Ø¨Ù†Ø§Ø¡ ØªØ¬Ø±ÙŠØ¨ÙŠ (Debug). Ù„Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Google Play ÙŠÙ„Ø²Ù… Ø¨Ù†Ø§Ø¡ Release Ù…ÙˆÙ‚Ù‘Ø¹.
          files: ${{ steps.apk_info.outputs.apk_name }}
          draft: false
          prerelease: ${{ github.event.inputs.build_type != 'release' }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ 18. Ù…Ù„Ø®Øµ Ù†Ù‡Ø§Ø¦ÙŠ â”€â”€
      - name: ğŸ“Š Build Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø¨Ù†Ø¬Ø§Ø­!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ“± Ø§Ù„Ù…Ù„Ù: ${{ steps.apk_info.outputs.apk_name }}"
          echo "  ğŸ“ Ø§Ù„Ø­Ø¬Ù…: ${{ steps.apk_info.outputs.apk_size }}"
          echo "  ğŸ”— Artifacts: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          echo "  ğŸ·ï¸ Release: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/tag/v${{ github.run_number }}-apk"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
