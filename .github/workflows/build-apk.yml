name: ğŸ“± Build Android APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

permissions:
  contents: write

jobs:
  build:
    name: ğŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:

      # â”€â”€ 1. Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯ â”€â”€
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ 2. Ø¥Ø¹Ø¯Ø§Ø¯ Java 17 Ø¨Ø¯ÙˆÙ† Ø£ÙŠ JVM options Ù…Ø³Ø¨Ù‚Ø© â”€â”€
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # â”€â”€ 3. Ù…Ø³Ø­ Ù…ØªØºÙŠØ±Ø§Øª Java Ø§Ù„ØªÙŠ ØªØ³Ø¨Ø¨ Ø§Ù„Ø®Ø·Ø£ â”€â”€
      - name: ğŸ§¹ Clear Java environment variables
        run: |
          echo "JAVA_TOOL_OPTIONS=" >> $GITHUB_ENV
          echo "GRADLE_OPTS=" >> $GITHUB_ENV
          echo "_JAVA_OPTIONS=" >> $GITHUB_ENV
          echo "JDK_JAVA_OPTIONS=" >> $GITHUB_ENV

      # â”€â”€ 4. Ø¥Ø¹Ø¯Ø§Ø¯ Node.js 20 â”€â”€
      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      # â”€â”€ 5. ØªØ«Ø¨ÙŠØª ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ â”€â”€
      - name: ğŸ“¦ Install npm dependencies
        run: npm ci || npm install

      # â”€â”€ 6. Ø¨Ù†Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Vite â”€â”€
      - name: ğŸ”¨ Build Vite project
        run: npm run build
        env:
          NODE_ENV: production

      # â”€â”€ 7. ØªØ«Ø¨ÙŠØª Capacitor â”€â”€
      - name: âš¡ Install Capacitor
        run: |
          npm install --save \
            @capacitor/core@5.7.0 \
            @capacitor/cli@5.7.0 \
            @capacitor/android@5.7.0

      # â”€â”€ 8. Ø¥Ù†Ø´Ø§Ø¡ capacitor.config.json â”€â”€
      - name: ğŸ“ Create Capacitor config
        run: |
          cat > capacitor.config.json << 'CAPEOF'
          {
            "appId": "com.ouldbouzidi.invoicemanager",
            "appName": "Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ±",
            "webDir": "dist",
            "android": {
              "allowMixedContent": true,
              "webContentsDebuggingEnabled": false
            }
          }
          CAPEOF

      # â”€â”€ 9. Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ© Android â”€â”€
      - name: ğŸ“± Add Android platform
        run: |
          if [ ! -f "android/app/build.gradle" ]; then
            npx cap add android
          else
            echo "âœ… Android platform already exists"
          fi

      # â”€â”€ 10. Ù…Ø²Ø§Ù…Ù†Ø© Capacitor â”€â”€
      - name: ğŸ”„ Sync Capacitor
        run: npx cap sync android

      # â”€â”€ 11. Ø¥Ø¹Ø¯Ø§Ø¯ local.properties â”€â”€
      - name: ğŸ”§ Setup Android SDK path
        run: |
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          echo "âœ… ANDROID_HOME: $ANDROID_HOME"

      # â”€â”€ 12. Ø¥ØµÙ„Ø§Ø­ gradle.properties Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ â”€â”€
      - name: âš™ï¸ Fix gradle.properties
        run: |
          GRADLE_PROPS="android/gradle.properties"

          # Ø§Ø­Ø°Ù Ø£ÙŠ Ø³Ø·Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ jvmargs Ù‚Ø¯ÙŠÙ…
          if [ -f "$GRADLE_PROPS" ]; then
            grep -v "org.gradle.jvmargs" "$GRADLE_PROPS" > /tmp/gradle.properties.tmp || true
            mv /tmp/gradle.properties.tmp "$GRADLE_PROPS"
          fi

          # Ø£Ø¶Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø¯ÙˆÙ† quotes Ø­ÙˆÙ„ Ù‚ÙŠÙ… JVM
          cat >> "$GRADLE_PROPS" << 'GRADLEOF'
          org.gradle.jvmargs=-Xmx2560m -Dfile.encoding=UTF-8
          org.gradle.daemon=false
          org.gradle.parallel=false
          org.gradle.configureondemand=false
          android.useAndroidX=true
          android.enableJetifier=true
          GRADLEOF

          echo "â”€â”€ Ù…Ø­ØªÙˆÙ‰ gradle.properties â”€â”€"
          cat "$GRADLE_PROPS"

      # â”€â”€ 13. ØµÙ„Ø§Ø­ÙŠØ§Øª Gradle â”€â”€
      - name: ğŸ”‘ Grant Gradle permissions
        run: |
          chmod +x android/gradlew
          ls -la android/gradlew

      # â”€â”€ 14. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Java â”€â”€
      - name: ğŸ” Verify Java setup
        run: |
          echo "JAVA_HOME: $JAVA_HOME"
          java -version
          echo "JAVA_TOOL_OPTIONS: '$JAVA_TOOL_OPTIONS'"
          echo "GRADLE_OPTS: '$GRADLE_OPTS'"

      # â”€â”€ 15. Ø¨Ù†Ø§Ø¡ APK Debug â”€â”€
      - name: ğŸ—ï¸ Build DEBUG APK
        if: ${{ github.event.inputs.build_type != 'release' }}
        working-directory: android
        run: |
          unset JAVA_TOOL_OPTIONS
          unset GRADLE_OPTS
          unset _JAVA_OPTIONS
          unset JDK_JAVA_OPTIONS
          ./gradlew assembleDebug \
            --no-daemon \
            --no-build-cache \
            --warning-mode all \
            2>&1

      # â”€â”€ 16. Ø¨Ù†Ø§Ø¡ APK Release â”€â”€
      - name: ğŸ—ï¸ Build RELEASE APK
        if: ${{ github.event.inputs.build_type == 'release' }}
        working-directory: android
        run: |
          unset JAVA_TOOL_OPTIONS
          unset GRADLE_OPTS
          unset _JAVA_OPTIONS
          unset JDK_JAVA_OPTIONS
          ./gradlew assembleRelease \
            --no-daemon \
            --no-build-cache \
            --warning-mode all \
            2>&1

      # â”€â”€ 17. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† APK ÙˆØªØ³Ù…ÙŠØªÙ‡ â”€â”€
      - name: ğŸ” Find and rename APK
        id: apk_info
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          APK_PATH=$(find android/app/build/outputs/apk -name "*.apk" 2>/dev/null | head -1)

          if [ -z "$APK_PATH" ]; then
            echo "âŒ APK not found! Searching..."
            find android -name "*.apk" 2>/dev/null || true
            exit 1
          fi

          echo "âœ… Found: $APK_PATH"
          APK_NAME="invoice-manager-${BUILD_TYPE}-v${{ github.run_number }}.apk"
          cp "$APK_PATH" "$APK_NAME"
          APK_SIZE=$(du -sh "$APK_NAME" | cut -f1)

          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "âœ… APK: $APK_NAME ($APK_SIZE)"

      # â”€â”€ 18. Ø±ÙØ¹ APK ÙƒÙ€ Artifact â”€â”€
      - name: ğŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: invoice-manager-apk-v${{ github.run_number }}
          path: ${{ steps.apk_info.outputs.apk_name }}
          retention-days: 30
          if-no-files-found: error

      # â”€â”€ 19. Ø¥Ù†Ø´Ø§Ø¡ GitHub Release â”€â”€
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}-apk
          name: "ğŸ“± Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± - Build #${{ github.run_number }}"
          body: |
            ## ğŸ“± Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†

            ### â¬‡ï¸ ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª:
            1. Ø­Ù…Ù‘Ù„ Ù…Ù„Ù `.apk` Ù…Ù† Ù‚Ø³Ù… **Assets** Ø£Ø¯Ù†Ø§Ù‡
            2. Ø§Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ù‡Ø§ØªÙÙƒ
            3. ÙØ¹Ù‘Ù„ **"Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©"** ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            4. Ø§ÙØªØ­ Ù…Ù„Ù APK ÙˆØ§Ø¶ØºØ· **ØªØ«Ø¨ÙŠØª** âœ…

            ### ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡:
            | | |
            |---|---|
            | ğŸ”¢ **Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡** | #${{ github.run_number }} |
            | ğŸ“¦ **Ø§Ù„Ø­Ø¬Ù…** | ${{ steps.apk_info.outputs.apk_size }} |
            | ğŸ”§ **Ø§Ù„Ù†ÙˆØ¹** | ${{ steps.apk_info.outputs.build_type }} |
            | ğŸ¤– **Android** | API 22+ (5.1 ÙØ£Ø¹Ù„Ù‰) |

            ### âœ¨ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:
            - ğŸ§¾ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ø­ØªØ±Ø§ÙÙŠØ§Ù‹
            - ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†
            - ğŸ“¦ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            - ğŸ“„ ØªØµØ¯ÙŠØ± PDF
            - ğŸ’¾ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª
          files: ${{ steps.apk_info.outputs.apk_name }}
          draft: false
          prerelease: ${{ github.event.inputs.build_type != 'release' }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ 20. Ù…Ù„Ø®Øµ Ù†Ù‡Ø§Ø¦ÙŠ â”€â”€
      - name: ğŸ“Š Build Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… APK ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!"
          echo "  ğŸ“± Ø§Ù„Ù…Ù„Ù : ${{ steps.apk_info.outputs.apk_name }}"
          echo "  ğŸ“ Ø§Ù„Ø­Ø¬Ù… : ${{ steps.apk_info.outputs.apk_size }}"
          echo "  ğŸ”— Ø±Ø§Ø¨Ø·  : $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
