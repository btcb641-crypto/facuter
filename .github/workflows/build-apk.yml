name: ğŸ“± Build Android APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

permissions:
  contents: write

jobs:
  build:
    name: ğŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:

      # â”€â”€ 1. Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯ â”€â”€
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ 2. Ø¥Ø¹Ø¯Ø§Ø¯ Java 17 â”€â”€
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # â”€â”€ 3. Ø¥Ø¹Ø¯Ø§Ø¯ Node.js 20 â”€â”€
      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      # â”€â”€ 4. ØªØ«Ø¨ÙŠØª ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ â”€â”€
      - name: ğŸ“¦ Install npm dependencies
        run: npm ci || npm install

      # â”€â”€ 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª public/ â”€â”€
      - name: ğŸ” Verify public/ files
        run: |
          echo "â”€â”€ Ù…Ù„ÙØ§Øª public/ â”€â”€"
          ls -la public/
          echo ""
          if [ ! -f "public/index.html" ]; then
            echo "âŒ public/index.html ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
            exit 1
          fi
          if [ ! -f "public/app.js" ]; then
            echo "âŒ public/app.js ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
            exit 1
          fi
          if [ ! -f "public/app.css" ]; then
            echo "âŒ public/app.css ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
            exit 1
          fi
          echo "âœ… Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª public/ Ù…ÙˆØ¬ÙˆØ¯Ø©"

      # â”€â”€ 6. ØªØ«Ø¨ÙŠØª Capacitor â”€â”€
      - name: âš¡ Install Capacitor
        run: |
          npm install --save \
            @capacitor/core@5.7.0 \
            @capacitor/cli@5.7.0 \
            @capacitor/android@5.7.0

      # â”€â”€ 7. Ø¥Ù†Ø´Ø§Ø¡ capacitor.config.json â”€â”€
      - name: ğŸ“ Create Capacitor config
        run: |
          cat > capacitor.config.json << 'CAPEOF'
          {
            "appId": "com.ouldbouzidi.invoicemanager",
            "appName": "Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ±",
            "webDir": "public",
            "android": {
              "allowMixedContent": true,
              "webContentsDebuggingEnabled": false
            }
          }
          CAPEOF
          echo "â”€â”€ capacitor.config.json â”€â”€"
          cat capacitor.config.json

      # â”€â”€ 8. Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ© Android â”€â”€
      - name: ğŸ“± Add Android platform
        run: |
          if [ ! -f "android/app/build.gradle" ]; then
            npx cap add android
          else
            echo "âœ… Android platform already exists"
          fi

      # â”€â”€ 9. Ù…Ø²Ø§Ù…Ù†Ø© Capacitor (ÙŠÙ†Ø³Ø® public/ â†’ android assets) â”€â”€
      - name: ğŸ”„ Sync Capacitor
        run: |
          npx cap sync android
          echo "â”€â”€ Ù…Ø­ØªÙˆÙ‰ android assets â”€â”€"
          ls -la android/app/src/main/assets/public/ 2>/dev/null || echo "Ù…Ø¬Ù„Ø¯ assets Ù„Ù… ÙŠÙÙ†Ø´Ø£ Ø¨Ø¹Ø¯"

      # â”€â”€ 10. Ø¥Ø¹Ø¯Ø§Ø¯ local.properties â”€â”€
      - name: ğŸ”§ Setup Android SDK path
        run: |
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          echo "âœ… ANDROID_HOME: $ANDROID_HOME"

      # â”€â”€ 10b. Ø¥Ø¹Ø¯Ø§Ø¯ Gradle Ø§Ù„Ø±Ø³Ù…ÙŠ â”€â”€
      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: "8.4"

      # â”€â”€ 10c. Ø¥Ù†Ø´Ø§Ø¡ gradle-wrapper.jar Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© â”€â”€
      - name: ğŸ“¦ Generate gradle-wrapper.jar
        run: |
          echo "â”€â”€ Ø¥Ù†Ø´Ø§Ø¡ gradle-wrapper.jar â”€â”€"
          mkdir -p android/gradle/wrapper

          # Ø¥Ù†Ø´Ø§Ø¡ gradle-wrapper.properties Ø¨Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
          cat > android/gradle/wrapper/gradle-wrapper.properties << 'WRAPEOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.4-bin.zip
          networkTimeout=10000
          validateDistributionUrl=true
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          WRAPEOF

          # Ø§Ø³ØªØ®Ø¯Ø§Ù… gradle Ø§Ù„Ù…Ø«Ø¨Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ wrapper
          cd android
          gradle wrapper --gradle-version 8.4 --distribution-type bin
          cd ..

          # Ø§Ù„ØªØ­Ù‚Ù‚
          if [ -f "android/gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "âœ… gradle-wrapper.jar ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡: $(du -sh android/gradle/wrapper/gradle-wrapper.jar)"
          else
            echo "âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ gradle-wrapper.jar"
            ls -la android/gradle/wrapper/
            exit 1
          fi

      # â”€â”€ 11. Ø¥Ø¹Ø¯Ø§Ø¯ gradle.properties Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ â”€â”€
      - name: âš™ï¸ Fix gradle.properties
        run: |
          GRADLE_PROPS="android/gradle.properties"

          # Ø§Ø­Ø°Ù Ø£ÙŠ Ø³Ø·Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ jvmargs Ù‚Ø¯ÙŠÙ…
          if [ -f "$GRADLE_PROPS" ]; then
            grep -v "org.gradle.jvmargs" "$GRADLE_PROPS" > /tmp/gradle.properties.tmp || true
            mv /tmp/gradle.properties.tmp "$GRADLE_PROPS"
          fi

          # Ø£Ø¶Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø¯ÙˆÙ† quotes Ø­ÙˆÙ„ Ù‚ÙŠÙ… JVM
          cat >> "$GRADLE_PROPS" << 'GRADLEOF'
          org.gradle.jvmargs=-Xmx2560m -Dfile.encoding=UTF-8
          org.gradle.daemon=false
          org.gradle.parallel=false
          org.gradle.configureondemand=false
          android.useAndroidX=true
          android.enableJetifier=true
          GRADLEOF

          echo "â”€â”€ Ù…Ø­ØªÙˆÙ‰ gradle.properties â”€â”€"
          cat "$GRADLE_PROPS"

      # â”€â”€ 12. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† gradle-wrapper.jar ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª â”€â”€
      - name: ğŸ”‘ Verify gradle-wrapper.jar and fix permissions
        run: |
          echo "â”€â”€ Ù…Ø­ØªÙˆÙ‰ android/gradle/wrapper/ â”€â”€"
          ls -la android/gradle/wrapper/

          if [ ! -f "android/gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "âŒ gradle-wrapper.jar ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø®Ø·ÙˆØ© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡!"
            exit 1
          fi

          echo "âœ… gradle-wrapper.jar Ù…ÙˆØ¬ÙˆØ¯: $(du -sh android/gradle/wrapper/gradle-wrapper.jar)"
          chmod +x android/gradlew
          echo "âœ… ØµÙ„Ø§Ø­ÙŠØ§Øª gradlew: $(ls -la android/gradlew)"

      # â”€â”€ 13. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Java ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø© â”€â”€
      - name: ğŸ” Verify Java setup and gradle wrapper
        run: |
          echo "JAVA_HOME: $JAVA_HOME"
          java -version
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† gradle-wrapper.jar
          echo "â”€â”€ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† gradle-wrapper.jar â”€â”€"
          ls -la android/gradle/wrapper/
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ù…Ù„Ù jar ØµØ§Ù„Ø­
          file android/gradle/wrapper/gradle-wrapper.jar || echo "Ù…Ù„Ù jar Ù…ÙˆØ¬ÙˆØ¯"
          java -cp android/gradle/wrapper/gradle-wrapper.jar org.gradle.wrapper.GradleWrapperMain --version 2>&1 | head -5 || echo "Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡"
          echo "JAVA_TOOL_OPTIONS: '$JAVA_TOOL_OPTIONS'"
          echo "GRADLE_OPTS: '$GRADLE_OPTS'"

      # â”€â”€ 14. Ø¨Ù†Ø§Ø¡ APK Debug â”€â”€
      - name: ğŸ—ï¸ Build DEBUG APK
        if: ${{ github.event.inputs.build_type != 'release' }}
        working-directory: android
        env:
          JAVA_TOOL_OPTIONS: ""
          GRADLE_OPTS: ""
          _JAVA_OPTIONS: ""
          JDK_JAVA_OPTIONS: ""
        run: |
          unset JAVA_TOOL_OPTIONS GRADLE_OPTS _JAVA_OPTIONS JDK_JAVA_OPTIONS JAVA_OPTS
          echo "âœ… JAVA_TOOL_OPTIONS: '${JAVA_TOOL_OPTIONS:-}'"

          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù€ ./gradlew Ø£ÙˆÙ„Ø§Ù‹
          if [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "â”€â”€ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù€ ./gradlew â”€â”€"
            ./gradlew assembleDebug \
              --no-daemon \
              --no-build-cache \
              --stacktrace \
              2>&1
          else
            echo "â”€â”€ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù€ gradle Ù…Ø¨Ø§Ø´Ø±Ø© â”€â”€"
            gradle assembleDebug \
              --no-daemon \
              --no-build-cache \
              2>&1
          fi

      # â”€â”€ 15. Ø¨Ù†Ø§Ø¡ APK Release â”€â”€
      - name: ğŸ—ï¸ Build RELEASE APK
        if: ${{ github.event.inputs.build_type == 'release' }}
        working-directory: android
        env:
          JAVA_TOOL_OPTIONS: ""
          GRADLE_OPTS: ""
          _JAVA_OPTIONS: ""
          JDK_JAVA_OPTIONS: ""
        run: |
          unset JAVA_TOOL_OPTIONS GRADLE_OPTS _JAVA_OPTIONS JDK_JAVA_OPTIONS JAVA_OPTS
          if [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            ./gradlew assembleRelease \
              --no-daemon \
              --no-build-cache \
              2>&1
          else
            gradle assembleRelease \
              --no-daemon \
              --no-build-cache \
              2>&1
          fi

      # â”€â”€ 16. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† APK ÙˆØªØ³Ù…ÙŠØªÙ‡ â”€â”€
      - name: ğŸ” Find and rename APK
        id: apk_info
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"

          echo "â”€â”€ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† APK â”€â”€"
          find android/app/build/outputs/apk -name "*.apk" 2>/dev/null || echo "Ù„Ø§ ÙŠÙˆØ¬Ø¯ APK ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ"
          find android -name "*.apk" 2>/dev/null || echo "Ù„Ø§ ÙŠÙˆØ¬Ø¯ APK ÙÙŠ Ù…Ø¬Ù„Ø¯ android"

          APK_PATH=$(find android/app/build/outputs/apk -name "*.apk" 2>/dev/null | head -1)

          if [ -z "$APK_PATH" ]; then
            echo "âŒ APK not found!"
            exit 1
          fi

          echo "âœ… Found: $APK_PATH"
          APK_NAME="invoice-manager-${BUILD_TYPE}-v${{ github.run_number }}.apk"
          cp "$APK_PATH" "$APK_NAME"
          APK_SIZE=$(du -sh "$APK_NAME" | cut -f1)

          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "âœ… APK: $APK_NAME ($APK_SIZE)"

      # â”€â”€ 17. Ø±ÙØ¹ APK ÙƒÙ€ Artifact â”€â”€
      - name: ğŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: invoice-manager-apk-v${{ github.run_number }}
          path: ${{ steps.apk_info.outputs.apk_name }}
          retention-days: 30
          if-no-files-found: error

      # â”€â”€ 18. Ø¥Ù†Ø´Ø§Ø¡ GitHub Release â”€â”€
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}-apk
          name: "ğŸ“± Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± - Build #${{ github.run_number }}"
          body: |
            ## ğŸ“± Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†

            ### â¬‡ï¸ ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª:
            1. Ø­Ù…Ù‘Ù„ Ù…Ù„Ù `.apk` Ù…Ù† Ù‚Ø³Ù… **Assets** Ø£Ø¯Ù†Ø§Ù‡
            2. Ø§Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ù‡Ø§ØªÙÙƒ
            3. ÙØ¹Ù‘Ù„ **"Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©"** ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            4. Ø§ÙØªØ­ Ù…Ù„Ù APK ÙˆØ§Ø¶ØºØ· **ØªØ«Ø¨ÙŠØª** âœ…

            ### ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡:
            | | |
            |---|---|
            | ğŸ”¢ **Ø±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡** | #${{ github.run_number }} |
            | ğŸ“¦ **Ø§Ù„Ø­Ø¬Ù…** | ${{ steps.apk_info.outputs.apk_size }} |
            | ğŸ”§ **Ø§Ù„Ù†ÙˆØ¹** | ${{ steps.apk_info.outputs.build_type }} |
            | ğŸ¤– **Android** | API 23+ (6.0 ÙØ£Ø¹Ù„Ù‰) |
            | ğŸŒ **Ø§Ù„Ù…Ø­Ø±Ùƒ** | HTML + CSS + JS (Ø¨Ø¯ÙˆÙ† React) |

            ### âœ¨ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:
            - ğŸ§¾ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ø­ØªØ±Ø§ÙÙŠØ§Ù‹
            - ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†
            - ğŸ“¦ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            - ğŸ“„ ØªØµØ¯ÙŠØ± PDF
            - ğŸ’¾ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª
            - ğŸ“± ÙˆØ§Ø¬Ù‡Ø© Ù…ØªØ¬Ø§ÙˆØ¨Ø© Ù…Ø¹ Ø§Ù„Ù‡Ø§ØªÙ
          files: ${{ steps.apk_info.outputs.apk_name }}
          draft: false
          prerelease: ${{ github.event.inputs.build_type != 'release' }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ 19. Ù…Ù„Ø®Øµ Ù†Ù‡Ø§Ø¦ÙŠ â”€â”€
      - name: ğŸ“Š Build Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… APK ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!"
          echo "  ğŸ“± Ø§Ù„Ù…Ù„Ù : ${{ steps.apk_info.outputs.apk_name }}"
          echo "  ğŸ“ Ø§Ù„Ø­Ø¬Ù… : ${{ steps.apk_info.outputs.apk_size }}"
          echo "  ğŸŒ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: public/ (HTML+CSS+JS)"
          echo "  ğŸ”— Ø±Ø§Ø¨Ø·  : $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
